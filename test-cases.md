# Тест-кейсы: Оплата заказа банковской картой

## Описание
Веб-приложение позволяет пользователю оплатить заказ банковской картой через внешний платежный шлюз.

Платежный процесс:
- Клиентская валидация
- Отправка данных в платежный шлюз
- Возможен редирект на 3-D Secure
- Платёжный шлюз возвращает результат: Успешно / Отклонено банком / Ошибка сервиса
- Приложение обновляет статус заказа
- Пользователю отображается результат оплаты
- На email отправляется чек (только при успешной оплате)

Формат тест-кейса: **ID / Название / Предусловия / Шаги / Ожидаемый результат**

---

## 1. Позитивные сценарии

### TC-PAY-001
**Название:** Успешная оплата валидной картой без 3‑D Secure  
**Предусловия:** Заказ в статусе «Ожидает оплаты», платежный шлюз доступен  
**Шаги:**
1. Открыть страницу оплаты заказа
2. Ввести валидные данные карты (номер/срок/CVC)
3. Нажать «Оплатить»
**Ожидаемый результат:**
- Клиентская валидация проходит
- Данные отправляются в платежный шлюз
- Получен результат «Успешно»
- Статус заказа обновлён на «Оплачен»
- Пользователю показано сообщение об успешной оплате
- На email отправлен чек

### TC-PAY-002
**Название:** Успешная оплата с прохождением 3‑D Secure  
**Предусловия:** Заказ «Ожидает оплаты», карта требует 3‑D Secure  
**Шаги:**
1. Открыть страницу оплаты
2. Ввести валидные данные карты
3. Нажать «Оплатить»
4. Пройти подтверждение 3‑D Secure (OTP/approve)
**Ожидаемый результат:**
- Происходит редирект/открытие 3‑D Secure
- После подтверждения шлюз возвращает «Успешно»
- Заказ обновлён на «Оплачен»
- Пользователь видит успешный результат
- Чек отправлен на email

---

## 2. Негативные сценарии

### TC-PAY-003
**Название:** Платёж отклонён банком  
**Предусловия:** Заказ «Ожидает оплаты», шлюз доступен, используется тестовая карта с результатом «Declined»  
**Шаги:**
1. Открыть страницу оплаты
2. Ввести данные карты
3. Нажать «Оплатить»
**Ожидаемый результат:**
- Шлюз возвращает «Отклонено банком»
- Заказ не становится «Оплачен»
- Пользователь видит сообщение об отказе
- Чек не отправляется

### TC-PAY-004
**Название:** Ошибка платёжного сервиса (timeout/5xx)  
**Предусловия:** Заказ «Ожидает оплаты», шлюз временно недоступен/возвращает ошибку  
**Шаги:**
1. Открыть страницу оплаты
2. Ввести валидные данные карты
3. Нажать «Оплатить»
**Ожидаемый результат:**
- Получена «Ошибка платёжного сервиса»
- Заказ не становится «Оплачен»
- Пользователь видит сообщение вида «Сервис оплаты временно недоступен, попробуйте позже»
- Чек не отправляется

### TC-PAY-005
**Название:** Пользователь отменил 3‑D Secure / неверный OTP  
**Предусловия:** Карта требует 3‑D Secure  
**Шаги:**
1. Ввести валидные данные карты
2. Нажать «Оплатить»
3. На 3‑D Secure нажать Cancel/ввести неверный OTP
**Ожидаемый результат:**
- Оплата неуспешна
- Заказ не становится «Оплачен»
- Пользователь видит сообщение о неуспешной оплате
- Чек не отправляется

---

## 3. Проверка валидации

### TC-PAY-VAL-001
**Название:** Пустые поля — запрос не уходит в шлюз  
**Предусловия:** Открыта страница оплаты  
**Шаги:**
1. Оставить поля пустыми
2. Нажать «Оплатить»
**Ожидаемый результат:**
- Показаны сообщения валидации для обязательных полей
- Запрос в платежный шлюз не отправляется

### TC-PAY-VAL-002
**Название:** Некорректный номер карты (формат/длина/Luhn)  
**Предусловия:** Открыта страница оплаты  
**Шаги:**
1. Ввести некорректный номер карты
2. Заполнить остальные поля валидно
3. Нажать «Оплатить»
**Ожидаемый результат:**
- Показана ошибка у поля номера карты
- Запрос в шлюз не отправляется

### TC-PAY-VAL-003
**Название:** Некорректный срок действия (истёк/неверный формат)  
**Предусловия:** Открыта страница оплаты  
**Шаги:**
1. Ввести валидный номер карты
2. Ввести срок (например, 00/25, 13/25, либо прошедший месяц/год)
3. Ввести валидный CVC
4. Нажать «Оплатить»
**Ожидаемый результат:**
- Показана ошибка у поля срока
- Запрос в шлюз не отправляется

### TC-PAY-VAL-004
**Название:** Некорректный CVC (неверная длина/символы)  
**Предусловия:** Открыта страница оплаты  
**Шаги:**
1. Ввести валидный номер и срок
2. Ввести CVC: 12 / 12345 / 12a
3. Нажать «Оплатить»
**Ожидаемый результат:**
- Показана ошибка у поля CVC
- Запрос в шлюз не отправляется

---

## 4. Граничные значения

### TC-PAY-BND-001
**Название:** Номер карты — минимальная допустимая длина (например, 16 цифр)  
**Предусловия:** Открыта страница оплаты  
**Шаги:** Ввести валидный номер минимальной длины + валидные срок/CVC → «Оплатить»  
**Ожидаемый результат:** Валидация проходит, запрос может быть отправлен

### TC-PAY-BND-002
**Название:** Номер карты — максимальная допустимая длина (например, 19 цифр)  
**Шаги:** Аналогично TC-PAY-BND-001, но номер максимальной длины  
**Ожидаемый результат:** Валидация проходит, запрос может быть отправлен

### TC-PAY-BND-003
**Название:** CVC = 3 цифры (min)  
**Ожидаемый результат:** Валидация проходит

### TC-PAY-BND-004
**Название:** CVC = 4 цифры (max, если поддерживается)  
**Ожидаемый результат:** Валидация проходит

### TC-PAY-BND-005
**Название:** Срок действия = текущий месяц/год (граница валидности)  
**Ожидаемый результат:** Поле срока валидно, оплата возможна

---

## 5. Интеграция с платежным шлюзом

### TC-PAY-INT-001
**Название:** Корректные параметры отправляются в шлюз (сумма, валюта, orderId, returnUrl)  
**Предусловия:** Доступен способ посмотреть/перехватить запрос (логирование/прокси/мок)  
**Шаги:**
1. Заполнить форму валидно
2. Нажать «Оплатить»
3. Проверить параметры запроса в шлюз
**Ожидаемый результат:**
- Передаются обязательные поля (сумма/валюта/orderId/returnUrl и т.п.)
- Значения соответствуют текущему заказу

### TC-PAY-INT-002
**Название:** Защита от двойного платежа (повторный клик/повторная отправка)  
**Предусловия:** Заказ «Ожидает оплаты»  
**Шаги:**
1. Быстро нажать «Оплатить» два раза (или обновить страницу в момент оплаты)
**Ожидаемый результат:**
- Не создаётся двойной платёж
- Итоговый статус заказа корректный и обновляется один раз

### TC-PAY-INT-003
**Название:** Callback/Webhook от шлюза корректно обновляет статус заказа  
**Предусловия:** На тестовом стенде доступны webhook/callback события  
**Шаги:**
1. Инициировать оплату
2. Дождаться webhook события (success/decline/error)
**Ожидаемый результат:**
- Статус заказа в системе соответствует пришедшему событию
